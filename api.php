<?php include_once 'init.php'; header('Content-Type: application/json'); $u = user(); $action = $_GET['action'] ?? ''; if($action=='send_message'){ if(!$u) die(json_encode(['ok'=>0])); $to=(int)$_POST['to']; $text=trim($_POST['text']); if(!$text) die(json_encode(['ok'=>0])); $db->prepare('INSERT INTO messages (from_user,to_user,text) VALUES (?,?,?)')->execute([$u['id'],$to,$text]); die(json_encode(['ok'=>1])); }
if($action=='get_messages'){ if(!$u) die(json_encode(['ok'=>0])); $with=(int)$_GET['with']; $stmt=$db->prepare('SELECT m.*, u.name as from_name FROM messages m JOIN users u ON u.id=m.from_user WHERE (m.from_user=? AND m.to_user=?) OR (m.from_user=? AND m.to_user=?) ORDER BY m.created_at ASC'); $stmt->execute([$u['id'],$with,$with,$u['id']]); $rows=$stmt->fetchAll(PDO::FETCH_ASSOC); echo json_encode(['ok'=>1,'messages'=>$rows]); }
if($action=='notifications'){ if(!$u) die(json_encode(['ok'=>0])); $stmt=$db->prepare('SELECT * FROM notifications WHERE user_id=? ORDER BY created_at DESC'); $stmt->execute([$u['id']]); echo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC)); }
?>